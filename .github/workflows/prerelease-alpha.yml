name: Pre-release Alpha

on:
  workflow_dispatch:

jobs:
  build-and-release-alpha:
    name: Build and Release Alpha
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore src/OutbreakTracker2.sln
        working-directory: ${{ github.workspace }}

      - name: Build solution
        run: dotnet build src/OutbreakTracker2.sln --configuration Release --no-restore
        working-directory: ${{ github.workspace }}

      - name: Publish main project
        id: publish_project
        run: |
          dotnet publish src/app/OutbreakTracker2.App/OutbreakTracker2.App.csproj --configuration Release --no-build --output ${{ github.workspace }}/publish_output
          echo "Main project published to ${{ github.workspace }}/publish_output"
        working-directory: ${{ github.workspace }}

      - name: Archive published output
        uses: thedoctor0/zip-release@0.7.5
        with:
          type: 'zip'
          filename: 'OutbreakTracker2-alpha-published.zip'
          path: '${{ github.workspace }}/publish_output'

      - name: Archive source code (excluding specified folders)
        uses: thedoctor0/zip-release@0.7.5
        with:
          type: 'zip'
          filename: 'OutbreakTracker2-alpha-source.zip'
          path: '${{ github.workspace }}/src'
          exclusions: '*.git* .github/* insights/* .idea/*'

      - name: Create Release Tag
        id: create_tag
        shell: pwsh
        run: |
          $tagName = "alpha-$(Get-Date -Format 'yyyyMMddHHmmss')"
          echo "TAG_NAME=$tagName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Generated tag: $tagName"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.create_tag.outputs.TAG_NAME }}
          release_name: Alpha Release ${{ steps.create_tag.outputs.TAG_NAME }}
          body: |
            Automated Alpha Pre-release for OutbreakTracker2.

            **Version:** ${{ steps.create_tag.outputs.TAG_NAME }}
            **Commit:** `${{ github.sha }}`

            This release includes:
            - Published application (executables, DLLs, etc.)
            - Source code (excluding 'insights' and '.idea' folders from 'src')
          draft: false
          prerelease: true

      - name: Upload Published Artifact to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ github.workspace }}/OutbreakTracker2-alpha-published.zip
          asset_name: OutbreakTracker2-alpha-published-${{ steps.create_tag.outputs.TAG_NAME }}.zip
          asset_content_type: application/zip

      - name: Upload Source Code to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ github.workspace }}/OutbreakTracker2-alpha-source.zip
          asset_name: OutbreakTracker2-alpha-source-${{ steps.create_tag.outputs.TAG_NAME }}.zip
          asset_content_type: application/zip
